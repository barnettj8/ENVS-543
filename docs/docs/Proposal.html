<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jackson Barnett">

<title>Assessment of Drivers in Virginia Reservoir Water Clarity Full Research Proposal</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="Proposal_files/libs/clipboard/clipboard.min.js"></script>
<script src="Proposal_files/libs/quarto-html/quarto.js"></script>
<script src="Proposal_files/libs/quarto-html/popper.min.js"></script>
<script src="Proposal_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Proposal_files/libs/quarto-html/anchor.min.js"></script>
<link href="Proposal_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Proposal_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Proposal_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Proposal_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Proposal_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Assessment of Drivers in Virginia Reservoir Water Clarity Full Research Proposal</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jackson Barnett </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The purpose of this project is to evaluate the role of abiogenic sediments, algae, and colored (chromophoric) dissolved organic matter (CDOM) in the water clarity of Virginia reservoirs. Water clarity is a key property of lakes because it determines the depth to which primary production occurs (i.e., the trophogenic zone; 1, 2). As abiogenic turbidity, algal abundance, and CDOM increase, light penetration decreases due to greater scattering and absorption of photons. As water clarity decreases, submerged aquatic vegetation declines while phytoplankton and algal blooms become more dominant (3, 1). Declines in water clarity cause a shift in lake state from a clear water macrophyte-dominated regime to a light-limited phytoplankton-dominated ecosystem (3). Loss of macrophyte communities diminishes littoral habitat structure and results in further reductions in water clarity due to greater sediment resuspension (5, 6). Increased algal blooms are associated with a range of water quality problems including low dissolved oxygen and the release of toxins harmful to humans and livestock (7, 8). A 2012 study of algae communities in 46 Virginia reservoirs found the majority to be meso- eutrophic and prone to cyanobacteria (a harmful algal bloom-producing bacteria) (9). Long-term changes in water clarity may, therefore, serve as a key indicator of trends in lake health.</p>
<p>Reservoirs are important components of the hydrologic landscape because they provide a range of ecosystem services such as public water supplies, sources of renewable energy, and opportunities for outdoor recreation. Within the Commonwealth of Virginia, and regionally in the southeastern US, reservoirs are the dominant lake type. A number of studies have examined the factors regulating water clarity in natural lakes, principally in the north temperate zone (4, 14, 15), but few studies have investigated the factors controlling water clarity in reservoirs. We know of no prior studies that have examined long-term trends in water clarity for this important group of lakes. The light climate of reservoirs is likely to be complex and dynamic owing to the multiple factors affecting light attenuation. These include abiogenic sediments (as indicated by Total Suspended Solids; TSS), algae (as indicated by Chlorophyll-a; CHLa), and dissolved color (CDOM). We expect their relative importance to vary among reservoirs, which differ in their geographic setting, and specifically, in relation to land use practices that affect sediment and nutrient inputs (10,4).</p>
<p>We developed hypotheses that consider landscape-scale (ecoregion), seasonal, and intra- lake spatial variation in water clarity. (H-I) We expect that abiogenic sediments will play a greater role in light attenuation among reservoirs in the Mountain and Piedmont regions where greater topographic variation results in higher sediment yields. We predict that algae will have a stronger influence on water clarity in lowland areas (Piedmont and Coastal Plain) where greater agricultural activity results in excess nutrient loads. Lastly, we expect that dissolved color will increase in importance in the Coastal Plain where predominantly sandy soils allow greater leaching of CDOM from natural vegetation. (H-II) Seasonally, we expect that CHLa will dominate light attenuation in Summer months when primary production is higher, and TSS will dominate in colder months and other periods with elevated runoff (1). (H-III) Intra-lake spatial variation may be important in reservoirs where upstream areas have high sediment loads due to river inputs, whereas downstream areas experience greater algal blooms due to longer water residence time. A preliminary analysis has allowed us to categorize a small set of lakes as being sediment- vs.&nbsp;algal-dominated based on the strength of univariate regressions between TSS and CHLa with clarity (Secchi depth). We propose to expand upon this analysis by collecting and examining additional data on the primary factors influencing light attenuation in six Virginia reservoirs.</p>
<p>Additionally, our examination of these hypotheses will further extend via a historical analysis of the full suite of reservoirs currently monitored by the Virginia Department of Environmental Quality (DEQ) (~100 lakes). The objective of this is to better assess the drivers of change in water clarity temporally and spatially. In addition to providing insight into the spatial and temporal variations in regulators, this portion will give a broad historical context to the field study results where a more detailed analysis of additional factors can be carried out. This study will help determine what proportion of Virginia reservoirs show trends in water clarity and whether these trends can be linked to changes in CHLa or TSS.</p>
</section>
<section id="methods" class="level2">
<h2 class="anchored" data-anchor-id="methods">Methods</h2>
<p>The primary methodology of this study will be split into two principal components. Component one is a six-month field study to characterize light attenuation and identify controlling factors (sediment, algae, and CDOM) for six reservoirs across multiple Virginia ecoregions. These data will provide a basis for assessing the relative importance of factors controlling reservoir water clarity, considering both intra-lake (seasonal and spatial) and inter-lake variations. Component two will focus on analyzing historical lake water quality data to assess long-term trends in water clarity and its regulating factors.</p>
<p>The study sites for the field portion of this study are being chosen from the list of reservoirs sampled by DEQ in the 2024 field season (May-October), with the exceptions of Harrison Lake and Chickahominy Lake. Sites were chosen in part due to their proximity to Richmond, however, represent a range of water clarity conditions that will provide variation in collected data. Data collection for most sites will last six months (May-October), however, Lake Anna will have approximately 18 months of data due to VCU sampling efforts prior to the creation of this study. Table 1, seen below, outlines the potential sites being considered for this study. Key characteristics such as reservoir area, ecoregion, and mean historical CHLa, Secchi Depth, and TSS are shown. These averages were calculated using DEQ data discussed in component two of this proposal. Final considerations of these reservoirs are being based upon the feasibility of riding along with DEQ for data collection during the field sampling season.</p>
<p><img src="images/clipboard-3331640165.png" class="img-fluid"></p>
<p>Sites will be sampled by boat and a vertical profile of general water quality parameters (dissolved oxygen, specific conductivity, etc.) will be created using a YSI Pro DDS sonde at 1m intervals. A vertical profile of light attenuation data will be recorded using a LI-COR LI-1400 data logger with surface quantum and underwater sensors (LI-190SA and LI-192SA). This measurement will be comprised of underwater irradiance measurements taken in 0.5-1m intervals from the surface through the photic layer. A linear regression of log-transformed downwelling irradiance and lake depth measurements will be used to find the light attenuation coefficients for a given site during sampling (Kd; m-1) (17).</p>
<p>A photic zone integrated water sample will be taken using the underwater irradiance data to find the 1% light level at each site. The integrated water sample will comprise 3-5 2 L samples taken at multiple depths within the photic zone. From this sample, water will be analyzed for TN, TP, CDOM, TSS, and CHLa. CHLa samples will be filtered through Whatman GF/A glass filters (0.5-μm nominal pore size), extracted for 18h in buffered acetone, and analyzed on a Turner Design TD-700 Fluorometer. TSS will be found gravimetrically with pre-weighed, pre- combusted filters (0.5 μm). CDOM samples will be filtered through glass filters (0.5 μm) and analyzed at wavelengths of 440 nm and 700 nm and a path length of 10cm using a Thermo Scientific dual beam Evolution 200 Series Spectrophotometer. Absorbance coefficients at 440 nm will be corrected with absorbance at 700 nm using methods outlined in Davies-Colley and Vant to account for any discrepancies in absorbance outside of the range of CDOM (16).</p>
<p>The historical portion of this study will use data obtained from DEQ to evaluate long- term trends in water clarity and assess the relative influence of suspended solids and algae on water clarity. Since 2000, DEQ has collected Secchi depth, TSS, and CHLa data on approximately 100 Virginia reservoirs. Data were collected monthly during May-October, though not all reservoirs are visited annually. For smaller reservoirs, data are collected at a single (near-dam) station, whereas larger reservoirs are monitored at multiple stations located along the longitudinal axis. The 20+ years of data will provide a historical context for assessing changes in water clarity. We will develop univariate linear models and generalized additive models (GAMs) to evaluate concurrent changes in TSS, CHLa, and Secchi depth for each monitoring location. Similarly, GAMS will be used to evaluate changes in TSS, CHLa, CDOM, and light attenuation across sites in the field portion of this study.</p>
<p>GAMs will let us view non-linear relationships in the data due to their non-parametric properties (11, 12). This will allow us to depict Secchi depth or light attenuation responses to each variable/predictor, conditioned on all additional variables. Modeling will follow the same process as described in Henderson and Bukaveckas for modeling estuarine light attenuation (13). The predictor variables will be day-of-year and decimal date to view both seasonal and long-term patterns. GAMs will be completed in R using the ‘mgcv’ package. Results will be scaled to the center of the mean for predictor assessment. These results will provide insight into Virginia’s reservoirs, as well as produce a publicly available R program that will be applicable to other state/regional water clarity datasets.</p>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>By characterizing trends in water clarity for over 100 Virginia reservoirs and assessing the factors controlling water clarity, this study will provide important information regarding status and trends for a key lake health variable. The results from this project will benefit lake associations by providing site-specific information, as well as regulatory agencies (i.e., DEQ) seeking to protect lake health through the development and application of numeric water quality criteria. Lastly, the findings will provide a broader contribution to the scientific literature on the light climate of reservoirs and the utility of monitoring data for assessing anthropogenic effects on water clarity. TSS, CHLa, and Secchi data are commonly collected by environmental agencies nationwide; this analysis will establish approaches for using historical and lake survey data to assess factors influencing water clarity. CDOM and light attenuation data are less commonly collected, however, our findings will help to establish the relative importance of their roles in understanding reservoir light environments.</p>
<p>Progress to date includes approximately one year of completed data collection from the Lake Anna study site, analysis of CHLa, TSS, and CDOM samples from Lake Anna, and communication with DEQ to receive all historical TSS, CHLa, and Secchi depth data. This data is in the early stages of being vetted, formatted, and QA/QC checked. The development of a general framework for statistical analyses has begun, however, there is still coding and review to be completed before results can be formed and interpreted.</p>
<p>Through this project, we hope to inform future management of Virginia’s water resources by both regulators and general stakeholders (e.g., lake associations). As harmful algal blooms increase in Virginia, accessible information as to their influence on light environments will become more relevant. Already, we have seen this through our collaboration with the Lake Anna Civic Association and Lake Anna property owners. Communication with these stakeholders has highlighted the need for more information on water clarity and the extent to which this is influenced by algal blooms.</p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<p>[1] Thornton, K. W., Kimmel, B. L., &amp; Payne, F. E. (1991). Reservoir limnology: ecological perspectives. John Wiley &amp; Sons.</p>
<p>[2] Davies-Colley, R.J., and D.G. Smith. (2001). Turbidity, suspended sediment, and water clarity: A review. Journal of the American Water Resources Association, 37 (5), 1085– 1101.</p>
<p>[3] King, L., Brahney, J., Daly, S., Paul, M. J., Salk, K. R., &amp; Brothers, S. (2023). Primary production modeling identifies restoration targets for shifting shallow, eutrophic lakes to clear-water regimes. Freshwater Science, 42(1), 44-57.</p>
<p>[4] Squires, M. M., &amp; Lesack, L. F. (2003). Spatial and temporal patterns of light attenuation among lakes of the Mackenzie Delta. Freshwater biology, 48(1), 1-20.</p>
<p>[5] James, W. F., Best, E. P., &amp; Barko, J. W. (2004). Sediment resuspension and light attenuation in Peoria Lake: can macrophytes improve water quality in this shallow system?. Hydrobiologia, 515, 193-201.</p>
<p>[6] United States Environmental Protection Agency. (2010). Chesapeake Bay Total Maximum Daily Load for Nitrogen, Phosphorus and Sediment. US Environmental Protection Agency, 93.</p>
<p>[7] Backer, L. C. (2012). Freshwater algal blooms &amp; public health. Lake line/North American Lake Management Society, 32(3), 7.</p>
<p>[8] Funari, E, &amp; Testai,E. (2008). Human Health Risk Assessment Related to Cyanotoxins Exposure, Critical Reviews in Toxicology, 38:2, 97-125, DOI: 10.1080/10408440701749454</p>
<p>[9] Marshall, H.G. (2013). Phytoplankton in Virginia lakes and reservoirs. Virginia Journal of Science, 64(1-2), 3-15.</p>
<p>[10] Loiselle, S. A., Azza, N., Cozar, A., Bracchini, L., Tognazzi, A., Dattilo, A., &amp; Rossi, C. (2008). Variability in factors causing light attenuation in Lake Victoria. Freshwater Biology, 53(3), 535-545.</p>
<p>[11] Morton, R., and B.L. Henderson. (2008). Estimation of non-linear trends in water quality: An improved approach using generalized additive models. Water Resources Research, 44: W07420.</p>
<p>[12] Yang, G., and D.L. Moyer. (2020). Estimation of non-linear water quality trends in high- frequency monitoring data. Science of the Total Environment 715: 136686.</p>
<p>[13] Henderson, R., Bukaveckas, P.A. (2022). Factors governing light attenuation in upper segments of the James and York estuaries and their influence on primary producers. Estuaries and Coasts, 45, 470–484.</p>
<p>[14] Sanderson, B. L. (1998). Factors regulating water clarity in northern Wisconsin lakes (Order No.&nbsp;9910427) [Doctoral dissertation, University of Wisconsin-Madison]. ProQuest Dissertations &amp; Theses Global. (304456486).</p>
<p>[15] James, W. F., Best, E. P., &amp; Barko, J. W. (2004). Sediment resuspension and light attenuation in Peoria Lake: can macrophytes improve water quality in this shallow system?. Hydrobiologia, 515, 193-201.</p>
<p>[16] Davies‐Colley, R. J., &amp; Vant, W. N. (1987). Absorption of light by yellow substance in freshwater lakes. Limnology and oceanography, 32(2), 416-425.</p>
<p>[17] Kirk, J.T.O. (2011). Light and Photosynthesis in aquatic ecosystems, 3rd ed.&nbsp;New York, NY: Cambridge University Press.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>
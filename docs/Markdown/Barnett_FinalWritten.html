<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jackson Barnett">

<title>Final Exam Written Document</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="Barnett_FinalWritten_files/libs/clipboard/clipboard.min.js"></script>
<script src="Barnett_FinalWritten_files/libs/quarto-html/quarto.js"></script>
<script src="Barnett_FinalWritten_files/libs/quarto-html/popper.min.js"></script>
<script src="Barnett_FinalWritten_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Barnett_FinalWritten_files/libs/quarto-html/anchor.min.js"></script>
<link href="Barnett_FinalWritten_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Barnett_FinalWritten_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Barnett_FinalWritten_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Barnett_FinalWritten_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Barnett_FinalWritten_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="Barnett_FinalWritten_files/libs/kePrint-0.0.1/kePrint.js"></script>

<link href="Barnett_FinalWritten_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">



</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Final Exam Written Document</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jackson Barnett </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="methods" class="level2">
<h2 class="anchored" data-anchor-id="methods">Methods</h2>
<p>To determine the extent to which changing climate may have impacted sex ratio divergence among locations in the Sonora Desert bark beetle, Araptus attenuatus, multiple statistical analyses were performed. We analyzed data collected from beetles sampled across multiple sites. At each site, beetles were randomly sampled from several plants, with each plant serving as a replicate within the site. The sex of each beetle was recorded as either male or female.</p>
<p>Q1 To test for differences in sex ratios among sites, we first summarized the data by calculating the number of males and the total number of beetles sampled at each site. A contingency table was then constructed to capture the counts of males and females across all sites. A Pearson’s Chi-squared test was applied to this contingency table to assess whether the observed sex ratios differed significantly among sites.</p>
<p>Q2 To identify which sites have sex ratios that deviate significantly from an equal proportion of males and females (50:50), we conducted a series of binomial tests. For each site, we tested whether the observed number of males significantly differed from the expected number under the assumption of equal proportions. Binomial tests were performed using the total number of beetles sampled at each site and the observed count of males. The resulting p-values from these tests were used to determine significance, with p &lt; 0.05 indicating a site where the sex ratio significantly deviated from equality.</p>
<p>Q3 To investigate the relationship between habitat suitability and the male-to-female sex ratio of beetles at the sampling locations, we utilized raster habitat suitability data, sampling locations, and sex ratio estimates aggregated to a single value per site. Habitat suitability measurements were derived from a raster dataset with a spatial resolution of 1 km², while sex ratios were calculated from raw data as the male-to-female ratio for each site. The habitat suitability raster was re-projected to the EPSG:4326 coordinate system to align with the spatial reference system of the sampling locations. Sampling locations, containing latitude and longitude information, were overlaid onto the habitat suitability raster, and suitability values corresponding to each site were extracted using site coordinates.</p>
<p>To assess the functional relationship, exploratory data analysis was first conducted by examining histograms of habitat suitability and male-to-female sex ratios to evaluate the normality of the distributions. A Pearson correlation test was then performed to quantify the strength and direction of the relationship between habitat suitability and sex ratio. Additionally, a linear regression model was fitted to predict the male-to-female ratio using habitat suitability as the explanatory variable. The model’s slope, intercept, R2, and p-value were recorded. Finally, a scatterplot was created to visualize the relationship between habitat suitability and the male-to-female ratio, with a fitted regression line and annotated model parameters.</p>
<p>Q4 To investigate whether the inclusion of Phenotype A and Phenotype B improves the functional relationship between habitat suitability and the male-to-female sex ratio, we expanded our analysis to include these additional predictors. First, we aggregated the raw beetle dataset by site, calculating the average values of Phenotype A and Phenotype B for each site. These averages were then combined with the previously calculated male-to-female ratio and habitat suitability values for each site to form a unified dataset.</p>
<p>Histograms of the average Phenotype A and Phenotype B values were examined to evaluate the normality of these predictors. Using this dataset, we constructed multiple linear regression models with habitat suitability as the dependent variable and different combinations of the three predictors—male-to-female ratio, average Phenotype A, and average Phenotype B—as independent variables.</p>
<p>To identify the best-fitting model, we assessed all possible combinations of predictors, ranging from single-variable models to a full model including all three predictors and their additive effects. For each model, we calculated the Akaike Information Criterion (AIC) and the coefficient of determination R2 as metrics for model performance. Lower AIC values indicated better model fit, while higher R2 values indicated greater explanatory power. Results for all models were tabulated for comparison.</p>
<p>Q5 To investigate whether habitat suitability has changed at sampling locations between the last glacial maximum (~20,000 years ago) and the present day, we used two raster datasets representing habitat suitability for the two time periods. Suitability values were extracted from each raster at the sampling locations, and the differences in suitability values between the present day and the glacial maximum were calculated. NORMALITY!!!!!!!</p>
<p>A paired t-test was conducted to determine whether the mean difference in suitability values between the two time periods was significantly different from zero. The null hypothesis stated that there was no difference in habitat suitability between the present day and the last glacial maximum, while the alternative hypothesis stated that the mean difference was not equal to zero.</p>
<p>Q6 To investigate changes in male-to-female ratios (MF ratios) across the landscape, we used a model derived from the relationship between current habitat suitability and MF ratio ( MF Ratio = − 0.73 * Habitat Suitability + 1.47 ). This model was applied to historical habitat suitability estimates from the Last Glacial Maximum raster and to present-day habitat suitability to predict sex ratios for both time periods at each sampling location. The difference between the two estimates (MFdifference = PresEstimate − MFestimate) was calculated to identify trends potentially driven by climatic changes over time.</p>
<p>To visualize these patterns, we mapped the spatial distribution of the predicted differences (MFdifference) using a color-coded scale. A custom color palette ranging from red (higher historical MF ratios) to green (higher present-day MF ratios) was created, with a neutral color (centered at zero difference) representing equal MF ratios. Predicted values were binned into 100 levels, with each bin assigned a corresponding color. These visualizations were overlaid on the habitat suitability raster to contextualize the patterns of sex ratio shifts across the landscape. A second visualization was use to view the extent of predicted historical sex ratios. Symbol size on the map represented the magnitude of the predicted historical sex ratios.</p>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>Q1 NEED A Q1 VISUALIZATION!!!!!!!!!!!</p>
<p>The Chi-squared test revealed a significant difference in sex ratios among the sampled sites. With a X2 value of 68.38, 30 degrees of freedom, and a p-value of 7.968e-05. This result indicates that the proportions of males and females were not consistent across the sampled sites. Instead, this shows that there are variations in sex ratios among the populations.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Pearson's Chi-squared test

data:  site_contingency
X-squared = 68.382, df = 30, p-value = 7.968e-05</code></pre>
</div>
</div>
<p>Q2</p>
<p>NEED Q2 RESULTS WRITE UP!!!!!!!!!!!!</p>
<div class="cell">
<div class="cell-output-display">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<caption>Sex Ratios Differing Significantly from Equal Proportions</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Site</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Males</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Total</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mfratio</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p_value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">9</td>
<td style="text-align: left;">Site 17</td>
<td style="text-align: right;">62</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1.6316</td>
<td style="text-align: right;">0.0209787</td>
</tr>
<tr class="even">
<td style="text-align: left;">10</td>
<td style="text-align: left;">Site 18</td>
<td style="text-align: right;">69</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">2.2258</td>
<td style="text-align: right;">0.0001831</td>
</tr>
<tr class="odd">
<td style="text-align: left;">13</td>
<td style="text-align: left;">Site 20</td>
<td style="text-align: right;">62</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1.6316</td>
<td style="text-align: right;">0.0209787</td>
</tr>
<tr class="even">
<td style="text-align: left;">14</td>
<td style="text-align: left;">Site 21</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1.7027</td>
<td style="text-align: right;">0.0120330</td>
</tr>
<tr class="odd">
<td style="text-align: left;">22</td>
<td style="text-align: left;">Site 29</td>
<td style="text-align: right;">62</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1.6316</td>
<td style="text-align: right;">0.0209787</td>
</tr>
<tr class="even">
<td style="text-align: left;">31</td>
<td style="text-align: left;">Site 9</td>
<td style="text-align: right;">37</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">0.5873</td>
<td style="text-align: right;">0.0120330</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Q3 The data was determined to be normal based on visual analysis of histogram plots (REFER TO FIGURES IN THE APPENDIX). The primary correlation analysis revealed a significant negative correlation between habitat suitability and the male-to-female sex ratio (r=−0.41, p=0.0215, 95% CI: [−0.67,−0.07]). This suggests that as habitat suitability increases, the male-to-female ratio decreases. The linear regression model further supported this relationship, with the equation:Male-Female Ratio = -0.73 * Habitat Suitability + 1.47</p>
<p>The regression model explained 16.9% of the variation in sex ratio (R2 = 0.169), and the slope of the relationship was statistically significant (p=0.0215).</p>
<p>The scatterplot (REFER TO FIGURE!!!!) displayed the data points, with habitat suitability on the x-axis and male-female ratio on the y-axis, along with a fitted regression line in red. The equation of the regression line, the coefficient of determination, and the p-value were annotated on the plot. The data indicated a clear trend, where sites in areas of higher habitat suitability exhibited lower male-female ratios.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>class      : Extent 
xmin       : -115 
xmax       : -109 
ymin       : 23 
ymax       : 30 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Barnett_FinalWritten_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Pearson's product-moment correlation

data:  site_sumgeom$habitat_suitability and site_sumgeom$mfratio
t = -2.4298, df = 29, p-value = 0.02153
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.66823344 -0.06664876
sample estimates:
      cor 
-0.411276 </code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Barnett_FinalWritten_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Q4 Again, to compare the functionality of different models with habitat suitability, the data were first assessed for normality via histograms (REFER TO IN THE APPENDIX!!!). The results of the model comparison are summarized in (REFER TO TABLE!!), which displays the AIC and R2 values for each combination of predictors. The single-variable model with the male-to-female ratio had the lowest AIC (-10.60) among all single-predictor models and an R2 of 0.169, indicating a modest explanatory power. The addition of Phenotype A or Phenotype B to the model increased R2 but at the cost of higher AIC values when these predictors were used independently.</p>
<p>The best-performing model, based on the lowest AIC value (-10.6), was the model that included only male-to-female ratio. This indicates that the inclusion of Phenotypes A and B do not improve the functional relationship over habitat suitability either on their own or in any combination.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<caption>AIC and R-squared Values for Each Model</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">AIC</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">R2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">mfratio</td>
<td style="text-align: right;">-10.602889</td>
<td style="text-align: right;">0.1691480</td>
</tr>
<tr class="even">
<td style="text-align: left;">Avg_PhenotypeA</td>
<td style="text-align: right;">-4.901224</td>
<td style="text-align: right;">0.0013780</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Avg_PhenotypeB</td>
<td style="text-align: right;">-5.185298</td>
<td style="text-align: right;">0.0104872</td>
</tr>
<tr class="even">
<td style="text-align: left;">mfratio_Avg_PhenotypeA</td>
<td style="text-align: right;">-8.773598</td>
<td style="text-align: right;">0.1737107</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mfratio_Avg_PhenotypeB</td>
<td style="text-align: right;">-9.897566</td>
<td style="text-align: right;">0.2031329</td>
</tr>
<tr class="even">
<td style="text-align: left;">Avg_PhenotypeA_Avg_PhenotypeB</td>
<td style="text-align: right;">-3.219780</td>
<td style="text-align: right;">0.0115873</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mfratio_Avg_PhenotypeA_Avg_PhenotypeB</td>
<td style="text-align: right;">-8.051844</td>
<td style="text-align: right;">0.2070888</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Q5</p>
</section>
<section id="appendix" class="level2">
<h2 class="anchored" data-anchor-id="appendix">Appendix</h2>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Barnett_FinalWritten_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Barnett_FinalWritten_files/figure-html/unnamed-chunk-13-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Barnett_FinalWritten_files/figure-html/unnamed-chunk-13-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Barnett_FinalWritten_files/figure-html/unnamed-chunk-13-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>